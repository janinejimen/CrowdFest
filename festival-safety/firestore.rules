rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // ---------- Users (non-sensitive) ----------
    match /users/{uid} {
      // User can read their own user doc (for routing/dashboard)
      allow read: if isSelf(uid);

      // Created by backend only
      allow create: if false;

      // User can update their own doc EXCEPT role
      allow update: if isSelf(uid)
        && !("role" in request.resource.data.diff(resource.data).changedKeys());

      allow delete: if false;
    }

    // ---------- Profiles (SENSITIVE: medical info) ----------
    match /profiles/{uid} {
      // User can read & write ONLY their own profile
      allow read, write: if isSelf(uid);

      // No one else (including organizers) can read directly
    }

    // ---------- Events ----------
    match /events/{eventId} {
      // Signed-in users can read events
      allow read: if signedIn();

      // Events are created/managed via Cloud Functions only
      allow write: if false;

      // Event membership
      match /members/{uid} {
        allow read: if signedIn();
        allow write: if false;
      }

      // Invites managed via Cloud Functions
      match /invites/{inviteId} {
        allow read, write: if false;
      }
    }

    // ---------- Invite Code Lookup ----------
    match /inviteCodes/{code} {
      allow read, write: if false;
    }

    // ---------- Emergency Access Logs ----------
    match /emergencyAccessLogs/{logId} {
      // Written only by Cloud Functions
      allow read, write: if false;
    }
  }
}
